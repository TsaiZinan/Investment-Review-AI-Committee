## 执行安全协议 (Safety Protocol)
1. **禁止 Heredoc**: 在执行涉及大量代码（超过 10 行）的 Python/Shell 逻辑时，严禁使用 `cat <<EOF` 或 `python -c` 方式直接在终端传输代码，防止缓冲区溢出导致卡死。
2. **文件化执行**: 必须先使用文件写入工具（如 `Write`）将代码保存为临时文件（例如 `scripts/temp_exec.py`），然后通过命令行运行该文件。

# 生成“最终投资总结.md”的总结分析 Prompt（输出到每日最终报告）

你是一个“投资建议汇总器”。你的任务：读取“当天日期文件夹”内所有类似命名的投资建议文件（例如 `YYYY-MM-DD_<模型名>_投资建议.md`），把它们的“大板块比例调整建议”“逐项建议表格”和“新增定投方向建议”做横向对比汇总，生成一份与示例 `最终投资总结.md` 相同结构与表格风格的 Markdown 文件，并保存到根目录的“每日最终报告”文件夹下（输出文件名前缀为 `YYYY-MM-DD_`）。

## 输入位置（必须按相对路径读取）
当天日期文件夹（将 `<DATE>` 替换为当天日期，如 `2026-01-01`）：
`报告/<DATE>/`

该目录内将存在若干文件，文件名形如：
- `<DATE>_DeepSeek-V3.1_投资建议.md`
- `<DATE>_Gemini-3-Pro-Preview_投资建议.md`
- `<DATE>_GPT-5.2_投资建议.md`
- `<DATE>_Grok-4_投资建议.md`

你必须以“通用规则”处理：读取目录下所有满足正则 `^<DATE>_.+_投资建议\.md$` 的文件（数量可能变化）。不要读取或引用其他非匹配文件。

## 输出位置（必须按相对路径写入）
输出文件路径（覆盖写入，将 `<DATE>` 替换为当天日期）：
`每日最终报告/<DATE>_最终投资总结.md`

## 生成规则（严格执行）
### 0) 安全约束（避免 Heredoc 风险）
- 在生成 Python 代码或 Shell 命令时（虽然本任务主要为文本汇总，但若涉及代码生成），严禁使用 heredoc (`<<EOF`) 格式进行多行内容写入。
- 必须使用标准的文件写入方式（如 Python 的 `open('file', 'w').write(...)` 或 Shell 的 `printf`），以避免终端执行时的卡死问题。

### 1) 只使用文件内已有信息
- 不能编造标的、比例、理由、数据来源。
- 如果某模型文件缺失某一标的/主题信息，用 `—` 表示该单元格缺失。

### 2) 识别“模型名”与列名（含归一化与去重）
- 对每个输入文件，从文件名中提取原始 `<模型名>` 作为 `raw_model`。
- 将 `raw_model` 归一化为 `canonical_model`（用于输出列名与后续统计），规则：
  - `Gemini*` → `Gemini`
  - `Kimi*` / `kimi` → `Kimi`
  - `MiniMax*` → `MiniMax-M2.1`
  - `TraeAI*` → `TraeAI`
  - `DeepSeek*` / `deepseek` → `DeepSeek`
  - `Grok*` / `grok*` → `Grok-4`
  - `GLM*` → `GLM-4.7`
  - 其余模型：保持原名
- 若归一化后同一天出现多个相同 `canonical_model`，你必须将其合并为同一列：
  - 对每个单元格：优先选择非 `—` 的值
  - 若多个值都非 `—`：优先选择文本更长者
  - 若仍无法区分：按 `raw_model` 字典序取更靠后者
- 输出表格列名使用 `canonical_model`。
- 模型列顺序：优先按固定顺序输出 `DeepSeek → Gemini → GPT-5.2 → Grok-4 → GLM-4.7 → Kimi → MiniMax-M2.1 → TraeAI`，其余模型按字典序追加。

### 3) 解析每个输入文件中必须用到的三块信息
对每个 `*_投资建议.md`：
- 解析“大板块比例调整建议（必须）”那张表（列一般包含：大板块、当前%、建议%、变动、建议（增配/减配/不变）等）。你只需要提取每个“大板块”的：
  - 建议%（数值）
  - 建议方向（增配/减配/不变/小幅减配/维持 等）
- 解析“定投计划逐项建议（全量，逐项表格）”那张表（列一般包含：标的、当前%、建议%、变动、建议、简短理由等）。你只需要提取每个“标的”的：
  - 建议%（数值）
  - 建议方向（增持/减持/不变/维持 等）
- 解析“新的定投方向建议（如有）”那张表：提取每个主题/方向与建议定投比例、口径、简短理由。

规范化要求：
- 将“维持”视为“不变”用于一致性统计，但展示时保留原词（例如写成 `7.00%（维持）`）。
- 将“大板块建议”里的“小幅增配/小幅减配”分别视为“增配/减配”用于一致性统计，但展示时保留原词（例如写成 `18.00%（小幅减配）`）。
- 百分比统一展示为两位小数：`7.00%`。若原表没有 `%` 符号也要补上。

### 4) 输出文件结构（必须与示例风格一致）
输出必须包含以下结构（标题日期为 `<DATE>`）：

1. 顶部标题：
- `# 投资总结（<DATE>）`

2. 第一部分：大板块比例调整建议横向对比
- 二级标题：`## 1. 大板块比例调整建议（按大类横向对比）`
- 一张总表，表头固定包含：
  - `大板块`
  - 每个模型一列（列名为模型名）
  - `一致性`
  - `分歧摘要`
- 每个大板块占一行，单元格展示格式：
  - `<建议%>（<建议方向>）`
  - 示例：`35.00%（增配）`

3. “一致建议”小节（紧跟在总表之后）
- 三级标题：`### 一致建议`
- 一张表（结构与上面的总表一致），只包含“一致性以「一致」或「基本一致」开头”的大板块行（忽略括号内偏向信息；`一致（增/减/不变）` 与 `基本一致（偏增/偏减/偏不变）` 均需纳入）。

4. 第二部分：逐项建议横向对比
- 二级标题：`## 2. 定投计划逐项建议（按标的横向对比）`
- 一张总表，表头固定包含：
  - `标的`
  - 每个模型一列（列名为模型名）
  - `一致性`
  - `分歧摘要`
- 每个标的占一行，单元格展示格式：
  - `<建议%>（<建议方向>）`
  - 示例：`12.50%（增持）`

5. “一致建议”小节（紧跟在总表之后）
- 三级标题：`### 一致建议`
- 一张表（结构与上面的总表一致），只包含“一致性以「一致」或「基本一致」开头”的标的行（忽略括号内偏向信息；`一致（增/减/不变）` 与 `基本一致（偏增/偏减/偏不变）` 均需纳入）。

6. 第三部分：新增定投方向横向对比
- 二级标题：`## 3. 新的定投方向建议（按主题横向对比）`
- 一张表，表头包含：
  - `主题/方向`
  - 每个模型一列
  - `异同`
- 主题/方向合并规则（必须执行）：
  - 目标：将“表达不同但指向相同/高度相近”的主题合并为同一行，避免重复主题分散在多行。
  - 合并口径：仅基于各模型文件里主题名称的文本相似性判断，不引入外部常识。
  - 规范化：对主题名做归一化用于判断相似性（展示仍保留原始主题名之一作为主名）：
    - 去除空格与常见修饰词：`ETF`、`指数`、`基金`、`定投`、`主题`、`方向`、`板块`、`赛道`、`相关`、`概念`
    - 全角/半角统一、大小写统一、中文括号/英文括号统一
  - 相似判定（满足其一即可合并）：
    - 规范化后完全相同
    - 规范化后互为包含（A 包含 B 或 B 包含 A）
    - 规范化后共享的核心关键词足够明显（例如至少 2 个相同关键词）；若无法确定则不要合并
  - 主主题命名：
    - 优先选择出现频率更高或更通用的主题名作为“主主题/方向”
    - 在“异同”列注明合并来源：例如 `合并：主题A / 主题B`
  - 单元格映射：
    - 若某模型在被合并组中任一原始主题上给出建议，则该模型列填入该建议（比例与口径）
    - 若某模型对同一合并组给出多个原始主题建议，不做加总；优先展示其“更接近主主题”的那一条，其余在“异同”列注明 `该模型另提：...`
- 单元格展示格式：
  - 若模型给出该主题：`<比例>%（<口径>）`，必要时可补充极短理由（不超过 12 字），但优先与示例一致，只展示“比例+口径”。
  - 若模型明确“本周期不新增”：在该模型列写 `0%（全组合）` 或直接写 `—`，但需要在“异同”列解释该模型的立场。

### 5) 一致性与分歧摘要计算（用于带“一致性/分歧摘要”的表格）
对每一行（大板块行 / 标的行），基于各模型的“建议方向”（将维持归入不变；大板块将小幅增配/小幅减配分别归入增配/减配）统计票数：
- 若所有模型方向一致：`一致性 = 一致`
- 若至少 75% 模型方向一致（例如 3/4，或 4/5）：`一致性 = 基本一致`
- 否则：`一致性 = 分歧`

同时，你必须在“一致性”字段中标明该行总体偏向方向（偏向增/减/不变）：
- 定义：以 `增/减/不变` 三类的票数最多者作为“偏向方向”
- 若存在唯一最多者：偏向方向分别写作 `偏增` / `偏减` / `偏不变`
- 若出现并列最多（例如 `2增/2减/0不变` 或 `1增/1减/1不变`）：偏向方向写作 `无明显偏向`
- 一致性字段展示格式（必须遵循）：
  - `一致（增）` / `一致（减）` / `一致（不变）`
  - `基本一致（偏增）` / `基本一致（偏减）` / `基本一致（偏不变）`
  - `分歧（偏增）` / `分歧（偏减）` / `分歧（偏不变）` / `分歧（无明显偏向）`

注意：对“### 一致建议”筛选时，只看一致性前缀（`一致` 或 `基本一致`），忽略括号内偏向信息。

分歧摘要字段格式（必须输出）：
- 方向统计：用 `增/减/不变` 的计数表达，例如 `2增/1减/1不变`
- 范围：用各模型“建议%”的最小与最大值（忽略缺失值），例如 `范围 11.00%–17.50%`
- 组合示例：`2增/1减/1不变；范围 11.00%–17.50%`

若某标的只有 1 个模型提供建议（其余缺失）：
- `一致性 = 分歧（偏增/偏减/偏不变 其一，按该模型方向）`
- 分歧摘要写：`数据不足；范围 <x>%–<x>%`

### 6) 标的与主题的“并集”口径
- 第一部分的“大板块”行集合取所有模型中出现过的大板块并集；若希望固定顺序，则按：债券 → 中股 → 期货 → 美股（当出现这些大板块时优先按该顺序，其余按字典序追加）。
- 第二部分的“标的”行集合取所有模型中出现过的标的并集，按中文排序或按首次出现顺序（任选其一，但要稳定一致）。
- 第三部分的“主题/方向”行集合取所有模型提出过的主题并集，但需要先按“主题/方向合并规则”做归并后再取并集；若某模型“无/本周期不新增”，在该模型列写 `—`，并在“异同”列标注“仅 X 提出”或“仅 X 明确不新增”等。

## 输出质量检查清单（生成后自检）
- 所有表格均为标准 Markdown 表格，列对齐一致。
- 第一、二部分每行都有“一致性”和“分歧摘要”。
- 百分比全部为两位小数并带 `%`。
- 不出现任何来自目录外的内容，不出现推测与新增结论。
